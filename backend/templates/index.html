<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>工作流创作与回顾 (最终功能版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
        .node-card {
            width: 140px;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            border: 2px solid #e5e7eb;
            transition: border-color 0.2s;
        }
        .node-card.selected {
            border-color: #3b82f6;
        }
        .thumb {
            width: 140px;
            height: 100px;
            object-fit: cover;
            background: #f3f4f6;
            display: block;
        }
        .node-label {
            padding: 6px 8px;
            font-size: 12px;
            color: #111827;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .link {
            fill: none;
            stroke: #9ca3af;
            stroke-width: 2px;
        }
        .overlay {
            position: fixed;
            left: 0; top: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal {
            background: #fff;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            padding: 12px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.4);
            overflow: auto;
        }
        .modal img, .modal video {
            max-width: 100%;
            max-height: 80vh;
            display: block;
            margin: 0 auto;
        }
        .loader { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-4">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-semibold text-gray-800">工作流创作与回顾</h1>
            <p id="status" class="text-gray-500 mt-1">正在从数据库加载作品...</p>
        </header>

        <main class="grid grid-cols-3 gap-6">
            <div class="col-span-2">
                <div id="chart-wrapper" class="bg-white rounded shadow p-3" style="height: 75vh; position: relative;">
                    <div id="chart" style="width:100%; height:100%;"></div>
                </div>
            </div>

            <div class="col-span-1">
                <div class="bg-white rounded shadow p-6 sticky top-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">工作流参数</h2>
                    <div id="workflow-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">父节点</label>
                            <input id="selected-node-input" type="text" value="未选择 (将创建根节点)" class="w-full bg-gray-100 border border-gray-300 rounded-md p-2 text-gray-500 text-sm" readonly>
                        </div>
                        <div>
                            <label for="module-select" class="block text-sm font-medium text-gray-600 mb-1">选择模块</label>
                            <select id="module-select" class="w-full bg-white border border-gray-300 rounded-md p-2">
                                <option value="TextGenerateImage">TextToImage</option>
                                <option value="ImageGenerateImage_Basic">ImageToImage</option>
                                <option value="TextGenerateVideo">TextToVideo</option>
                                <option value="ImageGenerateVideo">ImageToVideo</option>
                            </select>
                        </div>
                        <div>
                            <label for="prompt-input" class="block text-sm font-medium text-gray-600 mb-1">Prompt</label>
                            <textarea id="prompt-input" rows="4" class="w-full bg-white border border-gray-300 rounded-md p-2" placeholder="请输入您的创意..."></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="seed-input" class="block text-sm font-medium text-gray-600 mb-1">Seed</label><input type="number" id="seed-input" class="w-full bg-white border border-gray-300 rounded-md p-2" placeholder="随机"></div>
                            <div><label for="steps-input" class="block text-sm font-medium text-gray-600 mb-1">Steps</label><input type="number" id="steps-input" class="w-full bg-white border border-gray-300 rounded-md p-2" value="20"></div>
                            <div><label for="cfg-input" class="block text-sm font-medium text-gray-600 mb-1">CFG</label><input type="number" id="cfg-input" step="0.1" class="w-full bg-white border border-gray-300 rounded-md p-2" value="7.5"></div>
                            <div><label for="denoise-input" class="block text-sm font-medium text-gray-600 mb-1">Denoise</label><input type="number" id="denoise-input" step="0.05" class="w-full bg-white border border-gray-300 rounded-md p-2" value="0.8"></div>
                        </div>
                        <div>
                            <label for="image-upload" class="block text-sm font-medium text-gray-600 mb-1">图片输入 (可选)</label>
                            <input type="file" id="image-upload" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                            <p class="text-xs text-gray-500 mt-1">提示：上传新图将覆盖父节点图像。</p>
                        </div>
                        <div class="pt-2">
                            <button id="generate-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition-colors disabled:bg-gray-400">
                                <span id="button-text">开始生成</span>
                                <div id="button-loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="preview-overlay" style="display:none;"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const DB_API_GET_URL = '/api/trees/1';
    const DB_API_POST_URL = '/api/nodes';
    const COMFYUI_URL = 'http://223.193.6.178:8188';

    const statusEl = document.getElementById('status');
    const wrapper = document.getElementById('chart');
    const overlay = document.getElementById('preview-overlay');
    // 右侧面板的元素引用
    const selectedNodeInput = document.getElementById('selected-node-input');
    const moduleSelect = document.getElementById('module-select');
    const promptInput = document.getElementById('prompt-input');
    const generateBtn = document.getElementById('generate-btn');
    const imageUpload = document.getElementById('image-upload');
    const buttonText = document.getElementById('button-text');
    const buttonLoader = document.getElementById('button-loader');

    let selectedParentNodeId = null;
    let rootNodeId = null;
    let allNodes = [];

    
    function showStatus(text) { statusEl.textContent = text; }
    function parseAssetsField(assetsField) { if (!assetsField) return null; try { if (typeof assetsField === 'string') { if (assetsField.trim() === '' || assetsField.trim() === '{}') return null; return JSON.parse(assetsField); } else if (typeof assetsField === 'object') { return assetsField; } } catch (err) { console.warn('解析 assets 失败:', err, assetsField); return null; } return null; }
    function firstMediaFromAssets(assets) { if (!assets) return null; const imgs = assets.images || []; const vids = assets.videos || []; if (Array.isArray(imgs) && imgs.length > 0) return { path: imgs[0], type: 'image' }; if (Array.isArray(vids) && vids.length > 0) return { path: vids[0], type: 'video' }; return null; }
    function makeFullUrl(path) { if (!path) return null; if (path.startsWith('http://') || path.startsWith('https://')) return path; const cleanPath = path.startsWith('/') ? path : '/' + path; return COMFYUI_URL + cleanPath; }
    function openPreview(mediaUrl, type) { overlay.innerHTML = ''; overlay.style.display = 'flex'; overlay.className = 'overlay'; const modal = document.createElement('div'); modal.className = 'modal'; const closeBtn = document.createElement('div'); closeBtn.style.textAlign = 'right'; closeBtn.innerHTML = '<button class="px-3 py-1 bg-gray-200 rounded">关闭</button>'; closeBtn.querySelector('button').addEventListener('click', closePreview); modal.appendChild(closeBtn); if (type === 'video') { const v = document.createElement('video'); v.src = mediaUrl; v.controls = true; v.autoplay = true; modal.appendChild(v); } else { const img = document.createElement('img'); img.src = mediaUrl; img.alt = 'preview'; modal.appendChild(img); } overlay.appendChild(modal); overlay.addEventListener('click', (e) => { if (e.target === overlay) closePreview(); }); }
    function closePreview() { overlay.style.display = 'none'; overlay.innerHTML = ''; }
    // 此函数现在将图片发送给我们自己的后端 app.py
    async function uploadImage(file) {
        const formData = new FormData();
        formData.append('file', file);

        try {
            
            const response = await fetch('/api/assets/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`上传请求失败: ${errText}`);
            }
            return await response.json();
        } catch (error) {
            console.error("上传图片失败的真实原因:", error);
            alert('上传图片失败! (请检查控制台以获取详细错误)');
            return null;
        }
    }
    
    async function handleGenerate() {
        generateBtn.disabled = true;
        buttonText.textContent = '生成中...';
        buttonLoader.classList.remove('hidden');
        try {
            let parentId = selectedParentNodeId;
            if (!parentId) {
                if (allNodes.length > 0) { parentId = rootNodeId; }
                else { parentId = null; }
            }

            const moduleId = moduleSelect.value;
            const parameters = {
                positive_prompt: promptInput.value
            };
            const seed = document.getElementById('seed-input').value;
            parameters.seed = seed ? parseInt(seed) : Math.floor(Math.random() * 1000000000);

            ['steps', 'cfg', 'denoise'].forEach(id => {
                const el = document.getElementById(`${id}-input`);
                if (el.value) {
                    parameters[id] = (id === 'cfg' || id === 'denoise') ? parseFloat(el.value) : parseInt(el.value);
                }
            });

            const uploadedFile = imageUpload.files[0];
            if (uploadedFile) {
                const uploadResult = await uploadImage(uploadedFile);
                if (uploadResult?.name) { 
                    parameters.image_input = { type: 'new_upload', filename: uploadResult.name };
                } else {
                    throw new Error('图片上传后未收到有效文件名');
                }
            } else if (moduleId === 'ImageGenerateImage_Basic' || moduleId === 'ImageGenerateVideo') {
                if (selectedParentNodeId) {
                    parameters.image_input = { type: 'from_node', node_id: selectedParentNodeId };
                } else {
                    alert('使用图生图/视频功能，请先选择一个父节点或上传一张图片。');
                    throw new Error('缺少输入图片');
                }
            }
            const payload = {
                tree_id: 1,
                parent_id: parentId,
                module_id: moduleId,
                parameters: parameters
            };

            const response = await fetch(DB_API_POST_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`生成失败: ${errText}`);
            }
            await loadAndRender();

        } catch (error) {
            console.error(error);
            if (error.message.includes('缺少输入图片')) {
            } else {
                 alert(error.message);
            }
        } finally {
            generateBtn.disabled = false;
            buttonText.textContent = '开始生成';
            buttonLoader.classList.add('hidden');
            imageUpload.value = ''; // 清空文件选择
        }
    }

    async function loadAndRender() {
        // ... 此函数完全不变 ...
        try {
            showStatus('正在从数据库加载作品...');
            const res = await fetch(DB_API_GET_URL);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const treeData = await res.json();
            if (!treeData.nodes || treeData.nodes.length === 0) {
                showStatus('数据库中没有找到任何节点。请在右侧开始您的第一次生成。');
                allNodes = []; wrapper.innerHTML = ''; return;
            }
            allNodes = treeData.nodes;
            const root = allNodes.find(n => n.parent_id === null);
            rootNodeId = root ? root.node_id : null;

            const nodeMap = {};
            allNodes.forEach(n => {
                const parsedAssets = parseAssetsField(n.assets);
                const firstMedia = firstMediaFromAssets(parsedAssets);
                const media = firstMedia ? { rawPath: firstMedia.path, url: makeFullUrl(firstMedia.path), type: firstMedia.type } : null;
                nodeMap[n.node_id] = { id: n.node_id, parent_id: n.parent_id, module_id: n.module_id, created_at: n.created_at, status: n.status, media: media };
            });

            const fakeRoot = { id: '__ROOT__', module_id: 'ROOT', children: [] };
            Object.values(nodeMap).forEach(n => n.children = []);
            Object.values(nodeMap).forEach(n => {
                if (n.parent_id && nodeMap[n.parent_id]) {
                    nodeMap[n.parent_id].children.push(n);
                } else if (!n.parent_id) {
                    fakeRoot.children.push(n);
                }
            });
            renderTree(fakeRoot);
            showStatus('点击节点可设为父节点，点击缩略图可预览。');
        } catch (err) {
            console.error(err);
            showStatus('加载失败: ' + err.message);
        }
    }

    function renderTree(rootData) {
        wrapper.innerHTML = '';
        const width = wrapper.clientWidth || 1200;
        const height = wrapper.clientHeight || 600;

        const svg = d3.select('#chart').append('svg').attr('width', '100%').attr('height', '100%').attr('viewBox', `0 0 ${width} ${height}`).attr('preserveAspectRatio', 'xMidYMid meet');
        const g = svg.append('g').attr('transform', `translate(80, ${height/2})`);
        const zoom = d3.zoom().scaleExtent([0.1, 2.5]).on('zoom', (event) => g.attr('transform', event.transform));
        svg.call(zoom);

        const root = d3.hierarchy(rootData, d => d.children);
        const treeLayout = d3.tree().nodeSize([180, 220]);
        treeLayout(root);

        g.selectAll('.link').data(root.links().filter(d => d.source.data.id !== '__ROOT__')).enter().append('path').attr('class', 'link').attr('d', d => `M${d.source.y+140},${d.source.x} C${d.source.y+180},${d.source.x} ${d.target.y-40},${d.target.x} ${d.target.y},${d.target.x}`).attr('stroke', '#9ca3af').attr('fill', 'none');
        const node = g.selectAll('.node').data(root.descendants().filter(d => d.data.id !== '__ROOT__')).enter().append('g').attr('class', 'node').attr('transform', d => `translate(${d.y}, ${d.x - 70})`);

        node.each(function(d) {
            const fo = d3.select(this).append('foreignObject').attr('width', 140).attr('height', 140).style('overflow', 'visible');
            const div = fo.append('xhtml:div').attr('class', 'node-card').style('cursor', 'pointer');
            div.on('click', function(event) {
                event.stopPropagation();
                selectedParentNodeId = d.data.id;
                selectedNodeInput.value = `已选择: ${d.data.id.substring(0, 8)}...`;
                d3.selectAll('.node-card').classed('selected', false);
                d3.select(this).classed('selected', true);
            });

            if (d.data.media && d.data.media.rawPath) {
                const rawPath = d.data.media.rawPath;
                const mediaUrl = d.data.media.url;
                const isVideo = (typeof rawPath === 'string') && (rawPath.includes('.mp4') || rawPath.includes('subfolder=video'));
                if (isVideo) {
                    const videoEl = div.append('xhtml:video').attr('class', 'thumb').attr('muted', true).attr('playsinline', true).attr('preload', 'metadata').node();
                    videoEl.autoplay = true; videoEl.loop = true; videoEl.muted = true; videoEl.playsInline = true; videoEl.src = mediaUrl;
                    videoEl.addEventListener('click', (ev) => { ev.stopPropagation(); openPreview(mediaUrl, 'video'); });
                } else {
                    const imgEl = div.append('xhtml:img').attr('class', 'thumb').attr('src', mediaUrl).attr('alt', d.data.module_id || 'thumb').node();
                    imgEl.addEventListener('click', (ev) => { ev.stopPropagation(); openPreview(mediaUrl, 'image'); });
                }
            } else {
                div.append('xhtml:div').attr('class', 'thumb').style('display','flex').style('align-items','center').style('justify-content','center').style('font-size','12px').style('color','#6b7280').text('无缩略图');
            }
            div.append('xhtml:div').attr('class', 'node-label').text(d.data.module_id || '(节点)');
            const titleText = (d.data.module_id || '') + (d.data.created_at ? ' · ' + d.data.created_at : '') + (d.data.status ? ' · ' + d.data.status : '');
            this.setAttribute('title', titleText);
        });
    }

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePreview(); });
    generateBtn.addEventListener('click', handleGenerate);
    loadAndRender();
});
</script>
</body>
</html>